name: Weekly Backtest

on:
  schedule:
    # Run every Sunday at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      game_type:
        description: 'Game type to backtest'
        required: false
        default: 'BOTH'
        type: choice
        options:
          - MEGA_6_45
          - POWER_6_55
          - BOTH
      test_size:
        description: 'Number of draws/days to test'
        required: false
        default: '30'
        type: string
      test_mode:
        description: 'Test mode'
        required: false
        default: 'draws'
        type: choice
        options:
          - draws
          - days

env:
  GO_VERSION: '1.21'

jobs:
  backtest:
    name: Backtest Algorithms
    runs-on: ubuntu-latest
    timeout-minutes: 60
    strategy:
      matrix:
        game_type:
          - MEGA_6_45
          - POWER_6_55

    steps:
      - name: Skip if not selected
        if: >
          github.event.inputs.game_type != 'BOTH' &&
          github.event.inputs.game_type != '' &&
          github.event.inputs.game_type != matrix.game_type
        run: echo "Skipping ${{ matrix.game_type }}"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install dependencies
        run: go mod download

      - name: Build backtester
        run: |
          mkdir -p bin
          go build -o bin/backtester ./cmd/backtester
          chmod +x bin/backtester

      - name: Create data directory
        run: mkdir -p data results

      - name: Run backtest - 30 draws
        run: |
          ./bin/backtester \
            --config=./configs/config.prod.yaml \
            --game-type=${{ matrix.game_type }} \
            --test-mode=draws \
            --test-size=${{ github.event.inputs.test_size || 30 }} \
            --output=results/backtest_${{ matrix.game_type }}_draws_$(date +%Y%m%d).json
        env:
          GRPC_SERVER_ADDRESS: ${{ secrets.GRPC_SERVER_ADDRESS }}

      - name: Run backtest - 30 days
        run: |
          ./bin/backtester \
            --config=./configs/config.prod.yaml \
            --game-type=${{ matrix.game_type }} \
            --test-mode=days \
            --test-size=${{ github.event.inputs.test_size || 30 }} \
            --output=results/backtest_${{ matrix.game_type }}_days_$(date +%Y%m%d).json
        env:
          GRPC_SERVER_ADDRESS: ${{ secrets.GRPC_SERVER_ADDRESS }}

      - name: Upload backtest results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backtest-results-${{ matrix.game_type }}-${{ github.run_number }}
          path: |
            results/*.json
            data/backtests/
          retention-days: 90

      - name: Generate backtest report
        if: success()
        run: |
          echo "## ðŸ“Š Backtest Report - ${{ matrix.game_type }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Period" >> $GITHUB_STEP_SUMMARY
          echo "- **Mode**: Draws and Days" >> $GITHUB_STEP_SUMMARY
          echo "- **Size**: ${{ github.event.inputs.test_size || 30 }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: $(date +%Y-%m-%d)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results Files" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -lh results/ || echo "No results found" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  aggregate-results:
    name: Aggregate Results
    runs-on: ubuntu-latest
    needs: backtest
    if: success()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-results

      - name: Generate summary report
        run: |
          echo "# ðŸ“Š Weekly Backtest Summary" > summary.md
          echo "" >> summary.md
          echo "**Date**: $(date +%Y-%m-%d)" >> summary.md
          echo "**Run ID**: ${{ github.run_number }}" >> summary.md
          echo "" >> summary.md
          echo "## Algorithm Performance" >> summary.md
          echo "Game Type | 30 Draws Accuracy | 30 Days Accuracy" >> summary.md
          echo "---|---|---" >> summary.md
          # TODO: Parse JSON results and populate table
          echo "See artifacts for detailed results" >> summary.md

      - name: Upload summary
        uses: actions/upload-artifact@v4
        with:
          name: backtest-summary-${{ github.run_number }}
          path: summary.md
          retention-days: 90

      - name: Create final summary
        run: |
          echo "## ðŸŽ¯ Weekly Backtest Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All backtests completed successfully for:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… MEGA 6/45" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… POWER 6/55" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check artifacts for detailed results." >> $GITHUB_STEP_SUMMARY
